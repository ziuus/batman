name: CI / Package / Release

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
# Give the workflow permissions to create releases and upload artifacts
permissions:
  contents: write
  packages: write

jobs:
  lint:
    name: Shellcheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck
      - name: Run shellcheck
        run: shellcheck batman || true

  test:
    name: Smoke test (mocked sysfs)
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - name: Prepare mocked sysfs files
        run: |
          printf '61' > battery_capacity
          printf 'Discharging' > battery_status
          printf '0' > conservation_mode
      - name: Run smoke test
        run: |
          chmod +x ./batman
          BATTERY_CAPACITY=$PWD/battery_capacity BATTERY_STATUS=$PWD/battery_status CONSERVATION_MODE=$PWD/conservation_mode ./batman status
      - name: Assert output contains expected text
        run: |
          BATTERY_CAPACITY=$PWD/battery_capacity BATTERY_STATUS=$PWD/battery_status CONSERVATION_MODE=$PWD/conservation_mode ./batman status | grep -q "Battery Capacity" 

  package:
    name: Package artifact
    runs-on: ubuntu-latest
    needs: test
    outputs:
      artifact-name: ${{ steps.set-artifact.outputs.name }}
    steps:
      - uses: actions/checkout@v4
      - name: Make batman executable
        run: chmod +x batman
      - name: Create release tarball
        id: set-artifact
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          if [ "$TAG" = "$GITHUB_REF" ]; then TAG=dev; fi
          NAME="batman-${TAG}.tar.gz"
          tar -czf "$NAME" batman README.md LICENSE VERSION
          echo "name=$NAME" >> $GITHUB_OUTPUT
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: batman-package
          path: '*.tar.gz'

  release:
    name: Create GitHub Release (tags only)
    runs-on: ubuntu-latest
    needs: [package, build-deb]
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4
      - name: Get tag name
        id: tag
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          release_name: ${{ steps.tag.outputs.tag }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Download package artifact
        uses: actions/download-artifact@v4
        with:
          name: batman-package
          path: ./downloaded
      - name: Download deb/artifacts
        uses: actions/download-artifact@v4
        with:
          name: batman-deb
          path: ./downloaded
      - name: Upload tar.gz to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./downloaded/batman-${{ steps.tag.outputs.tag }}.tar.gz
          asset_name: batman-${{ steps.tag.outputs.tag }}.tar.gz
          asset_content_type: application/gzip
      - name: Upload .deb to Release (if present)
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./downloaded/*.deb
          asset_name: batman-${{ steps.tag.outputs.tag }}.deb
          asset_content_type: application/vnd.debian.binary-package
      - name: Upload checksums to Release (if present)
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./downloaded/checksums.sha256
          asset_name: checksums-${{ steps.tag.outputs.tag }}.sha256
          asset_content_type: text/plain

  build-deb:
    name: Build Debian package and checksums
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - name: Prepare .deb layout
        run: |
          set -euo pipefail
          PKG=batman
          RAW_TAG=${GITHUB_REF#refs/tags/}
          if [ "$RAW_TAG" = "$GITHUB_REF" ]; then
            TAG=dev
          else
            TAG=$RAW_TAG
          fi
          # produce a Debian-friendly version: strip any leading non-digit chars
          # e.g. v1.0.3 -> 1.0.3 ; remove prefixes like 'release-' as well
          VER=$(echo "$TAG" | sed -E 's/^[^0-9]*//')
          if [ -z "$VER" ]; then
            VER="0.0.0-dev"
          fi
          echo "Computed Debian version: $VER"
          OUT=$PWD/out
          BUILD=$PWD/build/${PKG}_${VER}
          mkdir -p "$BUILD"/usr/local/bin
          mkdir -p "$BUILD"/DEBIAN
          cp ./batman "$BUILD"/usr/local/bin/batman
          chmod 0755 "$BUILD"/usr/local/bin/batman
          echo -e "Package: batman\nVersion: ${VER}\nSection: utils\nPriority: optional\nArchitecture: all\nDepends: bash\nMaintainer: ${GITHUB_REPOSITORY_OWNER} <>\nDescription: Simple battery manager CLI\n A tiny CLI to toggle Lenovo conservation mode and show battery status." > "$BUILD"/DEBIAN/control
          dpkg-deb --build "$BUILD"
          mkdir -p "$OUT"
          mv "${BUILD}.deb" "$OUT/"
          # create checksums
          sha256sum "$OUT"/*.deb > "$OUT"/checksums.sha256
      - name: Upload deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: batman-deb
          path: out/*

