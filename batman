#!/usr/bin/env bash
# BATMAN - single-file battery manager
# Combines status, conservation enable/disable, toggle, and an interactive menu.

set -euo pipefail

# Allow overriding these paths for testing or different hardware
CONSERVATION_MODE="${CONSERVATION_MODE:-/sys/devices/pci0000:00/0000:00:1f.0/PNP0C09:00/VPC2004:00/conservation_mode}"
BATTERY_CAPACITY="${BATTERY_CAPACITY:-/sys/class/power_supply/BAT0/capacity}"
BATTERY_STATUS="${BATTERY_STATUS:-/sys/class/power_supply/BAT0/status}"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print() { echo -e "$1$2${NC}"; }

check_file() {
    [ -e "$1" ] || return 1
}

show_battery_info() {
    print "$BLUE" "=== BATTERY INFORMATION ==="
    if check_file "$BATTERY_CAPACITY"; then
        capacity=$(cat "$BATTERY_CAPACITY" 2>/dev/null || echo "N/A")
        print "$GREEN" "Battery Capacity: ${capacity}%"
    else
        print "$YELLOW" "Battery capacity: interface not found"
    fi

    if check_file "$BATTERY_STATUS"; then
        status=$(cat "$BATTERY_STATUS" 2>/dev/null || echo "N/A")
        print "$BLUE" "Battery Status: ${status}"
    fi
}

show_conservation_status() {
    print "$BLUE" "=== CONSERVATION MODE ==="
    if check_file "$CONSERVATION_MODE"; then
        mode=$(cat "$CONSERVATION_MODE" 2>/dev/null || echo "?")
        if [ "$mode" = "1" ]; then
            print "$GREEN" "Conservation Mode: ENABLED (â‰ˆ60%)"
        elif [ "$mode" = "0" ]; then
            print "$YELLOW" "Conservation Mode: DISABLED (100%)"
        else
            print "$BLUE" "Conservation Mode: Unknown ($mode)"
        fi
    else
        print "$YELLOW" "Conservation mode interface not found"
    fi
}

write_conservation() {
    local val=$1
    if [ ! -e "$CONSERVATION_MODE" ]; then
        print "$RED" "Conservation interface not found: $CONSERVATION_MODE"
        return 2
    fi

    if [ -w "$CONSERVATION_MODE" ]; then
        echo "$val" > "$CONSERVATION_MODE" 2>/dev/null && return 0 || return 1
    else
        echo "$val" | sudo tee "$CONSERVATION_MODE" >/dev/null
        return $?
    fi
}

enable_conservation() {
    if write_conservation 1; then
        print "$GREEN" "Conservation mode ENABLED"
    else
        print "$RED" "Failed to enable conservation mode"
        return 1
    fi
}

disable_conservation() {
    if write_conservation 0; then
        print "$GREEN" "Conservation mode DISABLED"
    else
        print "$RED" "Failed to disable conservation mode"
        return 1
    fi
}

toggle_conservation() {
    if [ ! -e "$CONSERVATION_MODE" ]; then
        print "$RED" "Conservation interface not found"
        return 2
    fi
    cur=$(cat "$CONSERVATION_MODE" 2>/dev/null || echo "0")
    if [ "$cur" = "1" ]; then
        disable_conservation
    else
        enable_conservation
    fi
}

show_help() {
    cat <<EOF
BATMAN - Battery Manager

Usage: $0 [command]

Commands:
  status        Show battery and conservation status
  enable|on     Enable conservation mode (may require sudo)
  disable|off   Disable conservation mode (may require sudo)
  toggle        Toggle conservation mode
  interactive   Run the interactive menu
  help          Show this help

You can override sysfs paths with environment variables, e.g.:
  CONSERVATION_MODE=/tmp/fake_mode $0 status
EOF
}

interactive_menu() {
    while true; do
        echo ""
        echo "BATMAN - interactive menu"
        echo "1) Show battery status"
        echo "2) Show conservation status"
        echo "3) Enable conservation mode"
        echo "4) Disable conservation mode"
        echo "5) Toggle conservation mode"
        echo "0) Exit"
        read -p "Choose an option [0-5]: " opt
        case "$opt" in
            1) show_battery_info ;;
            2) show_conservation_status ;;
            3) enable_conservation ;;
            4) disable_conservation ;;
            5) toggle_conservation ;;
            0) exit 0 ;;
            *) echo "Invalid option" ;;
        esac
    done
}

case "${1:-status}" in
    status|-s)
        show_battery_info
        show_conservation_status
        ;;
    enable|on)
        enable_conservation
        ;;
    disable|off)
        disable_conservation
        ;;
    toggle)
        toggle_conservation
        ;;
    interactive|i)
        interactive_menu
        ;;
    help|-h|--help)
        show_help
        ;;
    *)
        echo "Unknown command: $1"
        show_help
        exit 2
        ;;
esac
